---
title: 一致性哈希算法

date: 2017-06-11 22:52:00

categories:
- 分布式架构

tags:
- 一致性哈希算法

---

## 一致性哈希算法

在分布式集群中，对机器的**添加、删除，或者机器故障后自动脱离集群这些操作**是分布式集群管理最基本的功能。如果采用常用的hash(object)%N算法，那么在有机器添加或者删除后，很多原有的数据就无法找到了，这样严重的违反了单调性原则。接下来主要讲解一下一致性哈希算法是如何设计的：

**1、环形Hash空间**

按照常用的hash算法来**将对应的key哈希到一个具有2^32次方个桶的空间中**，即0~(2^32)-1的数字空间中。现在我们可以将这些数字头尾相连，想象成一个闭合的环形。如下图

![](http://i.imgur.com/pxLLjsA.png)

**2、把数据通过一定的hash算法处理后映射到环上**

现在我们将object1、object2、object3、object4四个对象通过特定的Hash函数计算出对应的key值，然后散列到Hash环上。如下图：

    Hash(object1) = key1；
    Hash(object2) = key2；
    Hash(object3) = key3；
    Hash(object4) = key4；

![](http://i.imgur.com/UyMsKuP.png)

**3、将机器通过hash算法映射到环上**

在采用一致性哈希算法的分布式集群中将新的机器加入，其原理是通过使用与对象存储一样的Hash算法将机器也映射到环中（**一般情况下对机器的hash计算是采用机器的IP或者机器唯一的别名作为输入值**），然后<font color='red'>**以顺时针的方向计算，将所有对象存储到离自己最近的机器中。**</font>

假设现在有NODE1，NODE2，NODE3三台机器，通过Hash算法得到对应的KEY值，映射到环中，其示意图如下：

	Hash(NODE1) = KEY1;
	Hash(NODE2) = KEY2;
	Hash(NODE3) = KEY3;

![](http://i.imgur.com/UHNzty7.png)

通过上图可以看出对象与机器处于同一哈希空间中，这样按顺时针转动object1存储到了NODE1中，object3存储到了NODE2中，object2、object4存储到了NODE3中。在这样的部署环境中，hash环是不会变更的，因此，**通过算出对象的hash值就能快速的定位到对应的机器中**，这样就能找到对象真正的存储位置了。

**机器的删除与添加**

1、节点（机器）的删除

如果NODE2出现故障被删除了，那么按照顺时针迁移的方法，object3将会被迁移到NODE3中，这样仅仅是object3的映射位置发生了变化，其它的对象没有任何的改动

![](http://i.imgur.com/MEVCYVI.png)

2、节点（机器）的添加 

如果往集群中添加一个新的节点NODE4，通过对应的哈希算法得到KEY4，并映射到环中

通过按顺时针迁移的规则，**那么object2被迁移到了NODE4中**，其它对象还保持这原有的存储位置。

![](http://i.imgur.com/XxPL8q6.png)

通过对节点的添加和删除的分析，一致性哈希算法在保持了单调性的同时，还是数据的迁移达到了最小，这样的算法对分布式集群来说是非常合适的，避免了大量数据迁移，减小了服务器的的压力。

**虚拟主机是分布更加均匀**

由于一致性hash算法采用对机器做hash，然后落在圆上，当节点较少时，有可能会出现这些机器节点是均匀分布的现象，这可以采用虚节点的方式来改进。例如现在有四个节点，直接按hash计算后，可能会出现某节点负责的区域更广，而其他区域更窄，**虚节点的方式下则可划分为两百份，然后每五十个虚节点指向一个真实的节点机器**，这样就可保证节点的均匀分布了。


## Hash算法的好坏标准

判定哈希算法好坏的四个定义：

1、平衡性(Balance)：平衡性是指**哈希的结果能够尽可能分布到所有的缓冲中去**，这样可以使得所有的缓冲空间都得到利用。很多哈希算法都能够满足这一条件。

2、单调性(Monotonicity)：单调性是指如果已经有一些内容通过哈希分派到了相应的缓冲中，又有新的缓冲加入到系统中。哈希的结果应能够保证**原有已分配的内容可以被映射到原有的或者新的缓冲中去**，而不会被映射到旧的缓冲集合中的其他缓冲区。 

理解：增加、删除机器时，必然造成缓存分布变化，对于变化的缓存部分，需要进行移动，**保证通过新的Hash算法能够找到缓存数据**

3、分散性(Spread)：在分布式环境中，终端有可能看不到所有的缓冲，而是只能看到其中的一部分。当终端希望通过哈希过程将内容映射到缓冲上时，由于不同终端所见的缓冲范围有可能不同，从而导致哈希的结果不一致，最终的结果是相同的内容被不同的终端映射到不同的缓冲区中。这种情况显然是应该避免的，因为它导致相同内容被存储到不同缓冲中去，降低了系统存储的效率。分散性的定义就是上述情况发生的严重程度。好的哈希算法应能够尽量避免不一致的情况发生，也就是尽量降低分散性。 

理解：相同的内容应尽量被分配到同一个缓存区，否则同一个内容分布在多个地方，会存在数据不一致问题

4、负载(Load)：负载问题实际上是从另一个角度看待分散性问题。既然不同的终端可能将相同的内容映射到不同的缓冲区中，那么对于一个特定的缓冲区而言，也可能被不同的用户映射为不同的内容。与分散性一样，这种情况也是应当避免的，因此好的哈希算法应能够尽量降低缓冲的负荷。