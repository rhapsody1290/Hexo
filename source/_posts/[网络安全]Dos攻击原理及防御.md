---
title: Dos攻击原理及防御

date: 2016-08-04 00:00:00

categories:
- 网络安全

tags:
- Dos
- DDos
- 网络安全

---

## Dos攻击简介

DoS是Denial of Service的简称，即拒绝服务，造成DoS的攻击行为被称为DoS攻击，***其目的是使计算机或网络无法提供正常的服务***。最常见的DoS攻击有计算机网络 ***带宽攻击***和 ***连通性攻击***。

* ***带宽攻击*** 指以极大的通信量冲击网络，使得所有可用网络资源都被消耗殆尽，最后导致合法的用户请求无法通过。
* ***连通性攻击*** 指用大量的连接请求冲击计算机，使得所有可用的操作系统资源都被消耗殆尽，最终计算机无法再处理合法用户的请求。

## DDos攻击简介

传统上，攻击者所面临的主要问题是网络带宽，由于较小的网络规模和较慢的网络速度的限制，攻击者无法发出过多的请求。但大多数的DoS攻击还是需要相当大的带宽的，而以个人为单位的黑客们很难使用高带宽的资源。为了克服这个缺点，DoS攻击者开发了分布式的攻击。攻击者简单利用工具集合许多的网络带宽来同时对同一个目标发动大量的攻击请求，这就是DDoS(Distributed Denial of Service)攻击。

## 攻击表现方式★★★

无论是DoS攻击还是DDoS攻击，简单的看，都只是一种破坏网络服务的黑客方式，虽然具体的实现方式千变万化，但都有一个共同点，就是其根本目的是使受害主机或网络无法及时接收并处理外界请求，或无法及时回应外界请求。其具体表现方式有以下几种：

　1. 制造大流量***无用数据***，造成通往被攻击主机的网络拥塞，使被攻击主机无法正常和外界通信。
　2. 利用被攻击主机提供服务或传输协议上处理重复连接的缺陷，反复高频的发出攻击性的 ***重复服务请求***，使被攻击主机无法及时处理其它正常的请求。
　3. 利用被攻击主机所提供服务程序或传输协议的本身实现缺陷，反复发送 ***畸形的攻击数据*** 引发系统错误的分配大量系统资源，使主机处于挂起状态甚至死机。

## TCP三次连接及重要概念

### TCP连接三次握手

要理解dos攻击，首先要理解TCP连接的三次握手过程(Three-way handshake)。在TCP/IP协议中，TCP协议提供可靠的连接服务，采用三次握手建立一个连接。

<div align=center>
![](http://i.imgur.com/sSu5DYG.jpg)
</div>

* 第一次握手:建立连接时，客户端发送 ***SYN*** 包((SYN=i)到服务器，并进入 ***SYN_SEND*** 状态，等待服务器确认;
* 第二次握手:服务器收到SYN包，必须确认客户的SYN (ACK=i+1 )，同时自己也发送一个SYN包((SYN=j)}即 ***SYN+ACK*** 包，此时服务器进入 ***SYN_RECV*** 状态;
* 第三次握手:客户端收到服务器的SYN+ACK包，向服务器发送确认包 ***ACK*** (ACK=j+1)，此包发送完毕，客户端和服务器进入 ***ESTABLISHED*** 状态，完成三次握手，客户端与服务器开始传送数据。

### 一些重要概念

* 半连接：***收到SYN包而还未收到ACK包时的连接状态*** 称为半连接，即尚未完全完成三次握手的TCP连接。
* 半连接队列：在三次握手协议中，服务器维护一个半连接队列，***该队列为每个客户端的SYN包(SYN=i)开设一个条目***，该条目表明服务器已收到SYN包，并向客户发出确认，正在等待客户的确认包。这些条目所标识的连接在服务器处于SYN_RECV状态，当服务器收到客户的确认包时，删除该条目，服务器进入ESTABLISHED状态。
* Backlog参数：表示半连接队列的***最大容纳数目***。
* SYN-ACK重传次数：***服务器发送完SYN-ACK包，如果未收到客户确认包，服务器进行首次重传***，等待一段时间仍未收到客户确认包，进行第二次重传，***如果重传次数超过系统规定的最大重传次数，系统将该连接信息、从半连接队列中删除***。注意，每次重传等待的时间不一定相同。
* 半连接存活时间：是指半连接队列的条目存活的最长时间，也即***服务从收到SYN包到确认这个报文无效的最长时间，该时间值是所有重传请求包的最长等待时间总和***。有时也称半连接存活时间为Timeout时间、SYN_RECV存活时间。
* 上面 ***三个参数*** 对系统的TCP连接状况有很大影响

## 常见攻击与防范参考

### SYN Flood攻击（SYN洪水攻击）

***大纲：***
![](http://i.imgur.com/SKds3zZ.png)
<div style = "display:none;">
	<table cellspacing="0px">
		<tr><th>Dos攻击形式</th><th>解决方法</th></tr>
		<tr><td>1、固定源地址发起攻击</td><td>检测到某个IP地址发起较多报文，加入黑名单</td></tr>
		<tr><td>2、伪造IP地址进行攻击</td><td rowspan="2">方法1失效，原因：
	1、单个IP发送的SYN报文不会很多，达不到被拒绝的阈值
	2、伪装的IP若被拒绝到，正常用户使用该IP将会无法获得服务
	3、可以用三种解决方法方法，如下表</td></tr>
		<tr><td>3、僵尸网络固定源地址发起攻击</td></tr>
	</table>
	
	<table cellspacing=0px>
		<tr><th>解决方法</th><th>问题</th></tr>
		<tr><td>方法一：不断监视系统中连接队列，达到阈值就释放系统连接</td><td>入门级防御SYN Flood方法，正常连接也会淹没在其中而被释放</td></tr>
		<tr><td>方法二：延缓TCB分配</td><td>1、SYS Cache：cache（哈希表）中保存半连接信息，收到正确回应ACK后再分配TCB
	2、SYN cookie：根据SYN包按照一定的规则计算SYN+ACK包的初始序列。客户端返回ACK再次校验，若正确才分配TCB</td></tr>
		<tr><td>方法三：使用SYN Proxy防火墙</td><td>防火墙提供SYN代理，验证成功后才放行</td></tr>
	</table>
</div>

***原理：***

* 问题就出在TCP连接的三次握手中，假设一个用户***向服务器发送了SYN报文后突然死机或掉线***，那么服务器在发出SYN+ACK应答报文后是***无法收到客户端的ACK报文***的(第三次握手无法完成)，这种情况下服务器端一般会重试(***再次发送SYN+ACK给客户端***)，并等待一段时间后丢弃这个未完成的连接，这段时间的长度我们称为***SYN Timeout***，一般来说这个时间是分钟的数量级(***大约为30秒 - 2分钟***);
* 一个用户出现异常导致服务器的一个线程等待1分钟并不是什么很大的问题，但如果有一个恶意的攻击者大量模拟这种情况，服务器端将为了维护一个非常大的半连接列表而消耗非常多的资源
	* ***数以万计的半连接***，即使是简单的***保存并遍历也会消耗非常多的CPU时间和内存***，何况还要不断对这个列表中的IP进行***SYN+ACK的重试***。实际上如果服务器的TCP/IP栈不够强大，最后的结果往往是堆栈溢出崩溃
	* 即使服务器端的***系统足够强大***，服务器端也将忙于处理攻击者伪造的TCP连接请求而***无暇理睬客户的正常请求***(毕竟客户端的正常请求比率非常之小)，此时从正常客户的角度看来，服务器失去响应，这种情况我们称作：服务器端受到了SYN Flood攻击(SYN洪水攻击)。

***SYN Flood种类：***

![](http://i.imgur.com/jLdacJD.jpg)

1. Direct Attack 攻击方使用 ***固定的源地址*** 发起攻击，这种方法对攻击方的消耗最小
2. Spoofing Attack 攻击方使用变化的源地址发起攻击，这种方法需要攻击方 ***不停地修改源地址***，实际上消耗也不大
3. Distributed Direct Attack 这种攻击主要是使用***僵尸网络***进行***固定源地址***的攻击

***防范：***

对于第一种攻击的防范可以使用比较简单的方法，即对SYN包进行监视，如果发现某个IP发起了较多的攻击报文，直接将这个***IP列入黑名单***即可。当然下述的方法也可以对其进行防范。
对于源地址不停变化的攻击使用上述方法则不行，首先从某一个被伪装的IP过来的Syn报文可能不会太多，***达不到被拒绝的阈值***，其次从这个***被伪装的IP（真实的）的请求会被拒绝掉***，即导致正常用户使用该IP将会无法访问服务。因此必须使用其他的方法进行处理。

**1． 无效连接监视释放**
　　这种方法不停***监视系统的半开连接和不活动连接***，当***达到一定阈值时拆除这些连接***，从而释放系统资源。这种方法对于所有的连接一视同仁，而且由于SYN Flood造成的半开连接数量很大，正常连接请求也被淹没在其中被这种方式误释放掉，因此这种方法属于入门级防御SYN Flood方法。

**2． 延缓TCB分配方法**
　　从前面SYN Flood原理可以看到，消耗服务器资源主要是因为当SYN数据报文一到达，系统立即分配TCB，从而占用了资源。而SYN Flood由于很难建立起正常连接，因此，<font color="red">当正常连接建立起来后再分配TCB则可以有效地减轻服务器资源的消耗</font>。常见的方法是使用Syn Cache和Syn Cookie技术。

　　**Syn Cache技术：**
　　这种技术是在收到SYN数据报文时***不急于去分配TCB，而是先回应一个SYN ACK报文，并在一个专用HASH表（Cache）中保存这种半开连接信息，直到收到正确的回应ACK报文再分配TCB***。在FreeBSD系统中这种Cache每个半开连接只需使用160字节，远小于TCB所需的736个字节。在发送的SYN ACK中需要使用一个己方的Sequence Number，这个数字不能被对方猜到，否则对于某些稍微智能一点的Syn Flood攻击软件来说，它们在发送Syn报文后会发送一个ACK报文，如果己方的Sequence Number被对方猜测到，则会被其建立起真正的连接。因此一般采用一些加密算法生成难于预测的Sequence Number。

　　**Syn Cookie技术：**
　　对于SYN攻击，Syn Cache虽然不分配TCB，但是为了判断后续对方发来的ACK报文中的Sequence Number的正确性，***还是需要使用一些空间去保存己方生成的Sequence Number等信息***，也造成了一些资源的浪费。
　　***Syn Cookie技术则完全不使用任何存储资源***，这种方法比较巧妙，它***使用一种特殊的算法生成Sequence Number***，这种算法考虑到了对方的IP、端口、己方IP、端口的固定信息，以及对方无法知道而己方比较固定的一些信息，如MSS、时间等，在收到对方的ACK报文后，***重新计算一遍***，看其是否与***对方回应报文中的（Sequence Number-1）相同***，从而决定是否分配TCB资源。(<font color='red'>在接收到syn包后不分配TCB资源，而是根据SYN包计算出一个cookie，这个cookie作为将要返回syn+ack包的序号列，服务器中不存储序列号。下次客户端返回ack包时，再根据包头信息计算cookie，与ack包的序号加一进行对比，如果相等，则说明是正常的连接，分配资源建立连接</font>)

**3． 使用SYN Proxy防火墙**
　　Syn Cache技术和Syn Cookie技术总的来说是一种***主机保护技术***，需要系统的***TCP/IP协议栈的支持***，而目前***并非所有的操作系统支持这些技术***。因此很多防火墙中都提供一种SYN代理的功能，其主要原理是对试图穿越的SYN请求进行验证后才放行，下图描述了这种过程：

![](http://i.imgur.com/dR07Uvz.jpg)

　　从上图（左图）中可以看出，防火墙在确认了连接的有效性后，才向内部的服务器（Listener）发起SYN请求，在右图中，所有的无效连接均无法到达内部的服务器。而***防火墙采用的验证连接有效性的方法则可以是Syn Cookie或Syn Flood等其他技术***。
　　采用这种方式进行防范需要注意的一点就是防火墙需要对整个有效连接的过程发生的数据包***进行代理***，如下图所示：

<div align=center>
![](http://i.imgur.com/pM1a1P3.gif)
</div>

　　因为防火墙代替发出的SYN ACK包中使用的序列号为c，而服务器真正的回应包中序列号为c’，这其中有一个差值***|c-c’|***，在每个相关数据报文经过防火墙的时候进行序列号的修改。

## 参考文献
什么是Dos攻击？
http://blog.csdn.net/justdoitflyer/article/details/12870907
SYN Flood攻击及防御方法
http://blog.csdn.net/bill_lee_sh_cn/article/details/6065704

	
